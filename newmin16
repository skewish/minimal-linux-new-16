minimal-linux-new-16

1. parent system pre-setup (fyi)

64-bit debian (latest-stable-version)
10 GB build partition (ex. /dev/sda7, change to whatever you're using)
typical swap partition (new system will use it too)
internet connection

2. open a terminal & become su

3. install compiler software (if not present)

apt install build-essential
apt install bc bison flex gawk python rsync
apt install libelf-dev libncurses-dev libssl-dev

4. create & mount a filesystem on /dev/sda7

mkdir /mnt/sda7
mkfs.ext4 /dev/sda7
mount -t ext4 /dev/sda7 /mnt/sda7

5. add some directories

cd /mnt/sda7
mkdir {boot,dev,proc,sys,tmp,usr}

6. download & unpack the linux kernel & busybox source code

https://kernel.org/(latest-stable-version) --> /mnt/sda7/tmp
https://busybox.net/(latest-stable-version) --> /mnt/sda7/tmp

cd /mnt/sda7/tmp
tar -x -f linux*.tar.xz
tar -x -f busybox*.tar.bz2
chown -R 0.0 /mnt/sda7

7. install a monolithic kernel (ex. installing linux-5.10.12)

cd /mnt/sda7/tmp/linux*/
make clean
make distclean
make defconfig
make menuconfig (disable loadable module support & whatever you don't need)
make -j4
make install INSTALL_PATH=/mnt/sda7/boot
make headers_install INSTALL_HDR_PATH=/mnt/sda7/usr
cd /mnt/sda7
ln -f -s boot/vmlinuz* vmlinuz

8. create initramfs image for the new kernel (ex. for vmlinuz-5.10.12)

cd /mnt/sda7/boot
mkinitramfs -o initramfs-5.10.12 5.10.12 (ignore all module warnings)

9. extract userspace from the new initramfs image

cd /mnt/sda7
gunzip -c ./boot/initramfs* > ./tmp/initramfs.tmp
cpio -i -d < ./tmp/initramfs.tmp

10. remove extraneous stuff

rm /mnt/sda7/init
rm -f -r /mnt/sda7/conf
rm -f -r /mnt/sda7/scripts

11. update busybox

cd /mnt/sda7/tmp/busybox*/
make clean
make distclean
make menuconfig (change install destination to /mnt/sda7)
make
make install

12. add /mnt/sda7/etc/fstab

cat > /mnt/sda7/etc/fstab << 'done'
udev /dev devtmpfs defaults 0 0
proc /proc proc defaults 0 0
tmpfs /run tmpfs defaults 0 0
sysfs /sys sysfs defaults 0 0
/dev/sda7 / ext4 defaults 0 1
/dev/sda2 none swap sw 0 0
done

13. replace /mnt/sda7/etc/os-release

cat > /mnt/sda7/etc/os-release << 'done'
PRETTY_NAME="minimal-linux-new-16"
NAME="newmin16"
VERSION="v18"
HOME_URL="https://github.com"
done

14. add /mnt/sda7/etc/init.d/rcS

mkdir /mnt/sda7/etc/init.d
cat > /mnt/sda7/etc/init.d/rcS << 'done'
#!/bin/sh
mount -w -o remount /dev/sda7 /
rm -f -r /tmp;mkdir -m 1777 /tmp
rm /.ash_history
mount -a
swapon -a
done
chmod 0755 /mnt/sda7/etc/init.d/rcS

15. update grub2 (rec. password protect grub menu)

cd /
umount /dev/sda7
grub-install /dev/sda
update-grub

16. reboot (at grub menu select minimal-linux-new-16)

